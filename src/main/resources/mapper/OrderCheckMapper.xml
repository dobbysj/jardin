<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
        
<mapper namespace="com.javalec.ex.dao.OrderCheckDao">
	
	<!-- 특정 회원의 전체 구매건 -->
	<select id="countOrder" parameterType="String" resultType="Integer">
		select count(*) from orderlist_tb where ol_orderer_id = #{param1}	
	</select>
	
	<!-- 특정 회원이 작성한 전체 주문(페이징) -->
	<select id="getAllOrder" resultType="HashMap">
		select * from
		(select rownum rnum, k.* from
		(select ot.ol_order_num onum, sum(ol_final_price) osum, wm_concat(pt.p_name) p_name, max(ol_date) odate, wm_concat(distinct ol_status) ostatus
		from orderlist_tb ot
		left join product_tb pt on ot.p_num=pt.p_num
		where ol_orderer_id=#{m_id}
		group by ot.ol_order_num) k) r
		where <![CDATA[r.rnum>=#{pageDto.startRow}]]> and <![CDATA[r.rnum<=#{pageDto.endRow}]]> order by r.odate desc

<!-- 		select * from -->
<!-- 		(select rownum rnum, ot.onum, ot.osum, pt.p_name, ot.odate, ot.ostatus -->
<!-- 		from (select ol_order_num onum, sum(ol_final_price) osum, max(p_num) oname, max(ol_date) odate, max(ol_status) ostatus from orderlist_tb where ol_orderer_id = #{m_id} group by ol_order_num) ot, product_tb pt -->
<!-- 		where ot.oname = pt.p_num) r -->
<!-- 		where <![CDATA[r.rnum>=#{pageDto.startRow}]]> and <![CDATA[r.rnum<=#{pageDto.endRow}]]> order by r.odate desc -->
	</select>
	
	<!-- 주문취소(입금대기 - 취소) -->
	<delete id="deleteOrder">
		delete from orderlist_tb where ol_order_num = #{param1}
	</delete>

	<!-- 주문단위 상품들 불러오기 -->
	<select id="getOneSetOrder" resultType="HashMap">
		select rownum rnum, ot.ol_num, pt.p_name, ot.ol_amt, ot.ol_final_price, ot.ol_status 
		from (select ol_num, p_num, ol_amt, ol_final_price, ol_status from orderlist_tb where ol_order_num = #{ ol_order_num } and ol_status not in ('반품/취소')) ot, product_tb pt
		where ot.p_num = pt.p_num
		order by rnum asc
	</select>
	
	<!-- 반품신청 -->
	<insert id="returnRq">
		insert into return_tb values 
		(rt_seq.nextval, #{param1}, '반품', #{param2}, default, #{param3}, sysdate, null, #{param4})
	</insert>
	
	<!-- 수량 전체 반품 시 주문상품 삭제(주문 아니라 주문 건 안에서의 상품 하나) -->
	<delete id="updateOrderStatus">
		update orderlist_tb set ol_amt=0, ol_status='반품/취소' where ol_num=#{param1}
	</delete>
	
	<!-- 수량 일부 반품시 주문상품 수량 변경 -->
	<update id="updateOrderAmount">
		update orderlist_tb set ol_amt=#{param2}, ol_final_price=#{param3} where ol_num=#{param1}
	</update>
	
	<!-- 해당 주문건의 리뷰 작성 가능 상품 목록 불러오기 -->
	<select id="reviewReadyList" resultType="HashMap">
		select *
		from (select rownum rnum, ot.ol_order_num, ot.ol_num o_num, ot.p_num, pt.p_name, ot.ol_amt, ot.ol_final_price 
		from (select ol_order_num, ol_num, p_num, ol_amt, ol_final_price from orderlist_tb where ol_order_num = #{ol_order_num}) ot, product_tb pt
		where ot.p_num = pt.p_num) od
		where od.o_num not in (select rv.ol_num from review_user_tb rv)
		order by od.rnum
	</select>

	<!-- 해당 주문건의 리뷰 작성 완료한 상품 목록 불러오기 -->
	<select id="reviewEndList" resultType="HashMap">
		select *
		from (select rownum rnum, ot.ol_order_num, ot.ol_num o_num, ot.p_num, pt.p_name, ot.ol_amt, ot.ol_final_price 
		from (select ol_order_num, ol_num, p_num, ol_amt, ol_final_price from orderlist_tb where ol_order_num = #{ol_order_num}) ot, product_tb pt
		where ot.p_num = pt.p_num) od
		where od.o_num in (select rv.ol_num from review_user_tb rv)
		order by od.rnum
	</select>
	
	<!-- 주문상태 변경 -->
	<update id="updateStatus">
		update orderlist_tb set ol_status=#{param2} where ol_order_num=#{param1} 
	</update>
	
	<!-- 리뷰 등록 -->
	<insert id="review_insert" parameterType="com.javalec.ex.dto.ReviewUserDto">
		insert into review_user_tb values(ru_seq.nextval,#{p_num},#{m_num},#{ru_title},#{ru_content},#{ru_score},sysdate,0,'답변대기','노출',#{ru_img},#{ru_type},#{ol_num})
	</insert>
	
	<!-- 환불 insert -->
	<insert id="refundRequest">
		insert into refund_tb values
		(rf_seq.nextval, #{rf_receipt_num}, #{ol_num}, #{rf_price}, '환불접수', 
		(select ol_payment from orderlist_tb where ol_num=#{ol_num}), sysdate, null, '취소')
	</insert>

	<!-- 반품 테이블(특정회원) -->
	<select id="countReturnRefund" resultType="Integer">
		select count(*) from
		(select r.onum, wm_concat(distinct r.rt_receipt_date) rtf_date, wm_concat(distinct r.rt_sort) rtf_sort, wm_concat(r.p_name) rtf_p_name, wm_concat(distinct r.rt_price) rtf_price, wm_concat(distinct r.rt_status) rtf_status
		from (select ol.onum, rt.rt_receipt_date, rt_sort, ol.p_name, rt.rt_price, rt.rt_status  
		from (select ot.onum, ot.ol_num, pt.p_name, ot.ol_date
		from (select ol_order_num onum, ol_num, p_num, ol_date from orderlist_tb where ol_orderer_id = #{param1}) ot, product_tb pt
		where ot.p_num = pt.p_num) ol, return_tb rt 
		where ol.ol_num = rt.ol_num
		union
		select ol2.onum, rf.rf_receipt_date, rf_sort, ol2.p_name, rf.rf_price, rf.rf_status
		from (select ot2.onum, ot2.ol_num, pt2.p_name, ot2.ol_date
		from (select ol_order_num onum, ol_num, p_num, ol_date from orderlist_tb where ol_orderer_id = #{param1}) ot2, product_tb pt2
		where ot2.p_num = pt2.p_num) ol2, refund_tb rf 
		where ol2.ol_num = rf.ol_num) r
		group by r.onum)
	</select>
	
	<!-- 반품, 결제취소 항목 가져오기(환불테이블 아님 주의!!!!!) -->
	<select id="getAllRtrf" resultType="HashMap">
		select * from
		(select rownum rnum, k.* from
		(select r.ol_order_num, wm_concat(distinct r.rf_receipt_date) rtf_date, wm_concat(distinct r.rf_sort) rtf_sort, wm_concat(r.p_name) rtf_p_name, wm_concat(distinct r.rf_price) rtf_price, wm_concat(distinct r.rf_status) rtf_status from
		(select rtf.*, ol.ol_order_num, ol.ol_orderer_id, pd.p_name from
		(select ol_num, rt_receipt_date rf_receipt_date, rt_sort rf_sort, rt_price rf_price, rt_status rf_status from return_tb 
		union
		select ol_num, rf_receipt_date, rf_sort, rf_price, rf_status from refund_tb where rf_sort='취소') rtf
		left join orderlist_tb ol on rtf.ol_num=ol.ol_num
		left join product_tb pd on ol.p_num=pd.p_num
		where ol_orderer_id='Hong1') r
		group by r.ol_order_num) k)s
		where <![CDATA[s.rnum>='${pageDto.startRow}']]> and <![CDATA[s.rnum<='${pageDto.endRow}']]>
		order by s.rtf_date
	</select>
	
	<!-- 주문 상세페이지 주문상품 가져오기 -->
	<select id="proInOneOrder" resultType="HashMap">
		select p_name, ol_amt, p_price, oc_semi_sum, oc_deliv_fee, oc_final_sum from
		(select * from orderlist_tb ol
		left join product_tb pd on ol.p_num=pd.p_num
		left join orderlist_cou_tb oc on ol.ol_order_num=oc.ol_order_num
		where ol.ol_order_num=#{ol_order_num})
	</select>
	
	<!-- 주문 상세페이지 결제정보 및 배송지정보 가져오기 -->
	<select id="orderInfoDetail" resultType="HashMap">
		select * from
		(select ol_order_num, wm_concat(distinct ol_payment) ol_payment, wm_concat(distinct ol_date) ol_date from orderlist_tb
		group by ol_order_num) ol
		left join (select ol_order_num, m_name, re_name, re_zipcode, re_address1, re_address2, re_phone, re_tel, m_msg from orderer_receiver_tb) ort on ort.ol_order_num=ol.ol_order_num
		where ol.ol_order_num=#{ol_order_num}
	</select>
	
	<!-- 결제 취소 상품 정보 -->
	<select id="cancelInfoDetail" resultType="HashMap">
		select a.p_name, a.rf_price, a.rf_status from
		(select * from refund_tb rf
		left join orderlist_tb ol on rf.ol_num=ol.ol_num
		left join product_tb pd on pd.p_num=ol.p_num
		where ol.ol_order_num=#{ol_order_num})a
	</select>
	
	<!-- 반품 상품 정보 -->
	
	
	
	
	
	
	
	

	
</mapper>